module Game

open "UnityEngine.dll"
open UnityEngine

worldEntity World = {

  filler : int

  (*Landscapes : [Landscape]
  Jeep : Truck
  Zombies : [Zombie] // are created in the landscape in groups
  Pistols : [Gun]
  Flashs : [Light]
  GUIpanel : GUI
  Health : float
  ActiveBoR : string
  Counter : int

  rule Zombies =  
    let groups = 
      [for a in Landscapes do
       for b in a.Group do
       select b]
    let zombiegroup = 
      [for a in groups do
       for c in a.ZombieFollowers do
	     select c]
    let groupleader = 
      [for a in groups do
       where a.ZombieLeader.IsSome
       let z = a.ZombieLeader.Value
       select z]
    let group = groupleader @ zombiegroup
    if group.Count > 0 then
      yield group @ Zombies
  
  rule Zombies = 
    let zmbies = 
      [for a in Zombies do
       where (a.Destroyed = false)
       select a]
    //Debug.Log("zombies count = "+zmbies.Count)
    yield zmbies

  rule Health = 
    if ActiveBoR = "Medipack Red" then
      yield Health + 20.0f
      Debug.Log(Health)

  rule ActiveBoR = 
    if ActiveBoR = "Crossed Wrenches Red" then
      let resourcelist = ["Medipack Red";"Battery Black";"Jerry Can Green"]
      let rnd = Random.Range(0,3)
      yield resourcelist.[rnd]
  
  rule ActiveBoR = 
    let a = 
      [for a in Landscapes do
       for b in a.PickUps do
       for c in b.BonusAndResources do
       where c.Active
       select (c.NameOfBoR)]
    if a.Count > 0 then
      Debug.Log(a.Head)
      yield a.Head
      yield ""

  rule Landscapes, Counter, Gasstations  = 
    let ls = 
      [for a in Landscapes do
       select a]
    let gs = 
      [for b in Gasstations do
       select b]
    if (ls.Count > 0) then
      let randr = Random.Range(1,5) 
      if gs.Count > 0 then 
        let Headpos = if (ls.Head.Position.z < gs.Head.Position.z) then ls.Head.Position else gs.Head.Position
        if Counter > 7 then
          yield Landscapes, 0, new Gasstation(new Vector3(0.0f,0.0f, Headpos.z - 80.0f)) :: Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Position) < 200.0f)
        else
          yield (new Landscape(new Vector3(0.0f,0.0f,Headpos.z - 80.0f), randr)) :: Landscapes, Counter + 1, Gasstations
          yield Landscapes, Counter, Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Position) < 200.0f)
      else 
        let Headpos = ls.Head.Position
        if Counter > 7 then
          yield Landscapes, 0, new Gasstation(new Vector3(0.0f,0.0f, Headpos.z - 80.0f)) :: Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Position) < 200.0f)
        else
          yield (new Landscape(new Vector3(0.0f,0.0f,Headpos.z - 80.0f), randr)) :: Landscapes, Counter + 1, Gasstations
          yield Landscapes, Counter, Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Position) < 200.0f)*)

  Create() =
    {
     (*Landscapes = [new Landscape(new Vector3(0.0f,0.0f,-160.0f), 1); new Landscape(new Vector3(0.0f,0.0f,-80.0f), (4)); new Landscape((Vector3.zero), (2))] 
     Jeep = new Truck()
     Pistols = [new Gun()]
     Flashs = [new Light()]
     GUIpanel = new GUI()
     Health = 100.0f
     ActiveBoR = ""
     Counter = 3
     Zombies = []*)
     filler = 5
    }
}
(*
entity ControllerRazor= { // one hand
  inherit SixenseHand
  
  rule Shot = 
    if (Trigger || Input.GetMouseButtonDown(0) && (world.Pistols.Head.InMagazine > 0 && not (world.Pistols.Head.Reloading))) then
      yield true
      yield false

  rule Trigger =
    yield Trigger

  rule Bumper =
    yield Bumper

  Create(joystickName : string) = 
  {
    Base = SixenseHand.Instantiate(joystickName)
  }
}

entity Gun = {
  inherit UnityGun
  GunController : ControllerRazor
  NotInMagazine : int
  Reloading : bool
  ReloadDuration : float
  InMagazine : int
  MagazineSize : int
  Automatic : bool
  DamagePerBullet : float

  rule InMagazine = 
    if (GunController.Shot && InMagazine > 0 && (Reloading = false)) then
      yield InMagazine - 1

  rule NotInMagazine = 
    if world.ActiveBoR = "AmmoBox" then 
      yield NotInMagazine + 50
      Debug.Log("NotInMagazine = "+ NotInMagazine)

  rule Reloading, NotInMagazine, InMagazine = 
    if ((Input.GetKey(KeyCode.R) || InMagazine = 0) && NotInMagazine > 0) then
      yield true, NotInMagazine, InMagazine
      wait (ReloadDuration)
      if MagazineSize > NotInMagazine then // clip can't be fulled completely
        yield false, 0, NotInMagazine
      else 
        let changed = (MagazineSize - InMagazine)
        Debug.Log("changed = "+changed)
        yield false, NotInMagazine - changed, MagazineSize // fill clip completely

  rule MagazineGUI = 
    if world.Pistols.Count > 0 then
      yield MagazineGUI

  rule InMag, NotInMag = 
    if world.Pistols.Count > 0 then
      yield InMagazine, NotInMagazine

  rule Reloading = 
    if Input.GetKey(KeyCode.C) then
      yield false

  Create(st : string, ind : int) = 
  let autom = if (st <> "MachineGun") then false else true
  //                        Light Machine Gun ; Pistol; ShotGun ; Revolver; Bazooka
  let InMagList =           [50               ; 20 ;    5       ; 6       ; 1]
  let NotInMagList = [       850              ; 200 ;   60      ; 90      ; 15]
  let ClipSizeList = [       150              ; 20 ;    5       ; 6       ; 1]
  let ReloadDurationList = [ 7.0f             ; 3.0f ;  4.0f    ; 2.0f    ; 5.0f]
  let DamageList = [         40.0f            ; 75.0f ; 135.0f  ; 100.0f  ; 400.0f]
  {
    Base = UnityGun.Instantiate(st)
    GunController = new ControllerRazor("Hydra1 - Right")//righthand
    NotInMagazine = NotInMagList.[ind]
    Reloading = false
    MagazineSize = ClipSizeList.[ind]
    InMagazine = InMagList.[ind]
    ReloadDuration = ReloadDurationList.[ind]
    Automatic = autom
    DamagePerBullet = DamageList.[ind]
  }
}

entity Light = { //flashlight
  LightController : ControllerRazor
  Battery : float
  Active : bool
  
  rule Active =
    yield LightController.Trigger

  rule Battery = 
     if world.ActiveBoR = "Battery Black" then 
       Debug.Log("Battery = "+Battery)
       yield Battery + 50.0f
    
  rule Battery = 
    //Debug.Log("Battery: " + Battery)
    if Active && Battery > 0.49f then
      yield Battery - 0.5f
    else
      yield Battery

  Create() = 
  {
    LightController = new ControllerRazor("Hydra1 - Left")//lefthand
    Battery = 100.0f
    Active = false
  }
}

entity GUI = { //panel. Each wall contains the same info?
  inherit GUIBarScript

  rule Value =
    yield world.Jeep.CarHP2

  Create() = 
  {
    Base = GUIBarScript.Find()
  }

}

entity Landscape = { //here are the zombies created and destroyed after a frame
  inherit UnityLandscape
  Group : [GroupZombie]
  PickUps : [PickUp]
  Spawnpoints : [Transform]

  rule Group, PickUps, Spawnpoints = // spawning multiple groups on a single landscape
    wait Spawnpoints.Count > 0
    let random_spawnp = Random.Range(0,4) 
    let random_pickup = Random.Range(0,4)
    if random_spawnp <> random_pickup then
      let sps = Spawnpoints.[random_spawnp]
      let sps_pos = sps.position
      let rpu = Spawnpoints.[random_pickup]
      let rpu_pos = rpu.position
      yield [new GroupZombie(sps_pos)], [new PickUp(rpu_pos)], []
      wait false
    else 
      let sps1 = Spawnpoints.[1]
      let sps_pos1 = sps1.position
      let rpu1 = Spawnpoints.[2]
      let rpu_pos1 = rpu1.position
      yield [new GroupZombie(sps_pos1)], [new PickUp(rpu_pos1)], []
      wait false

  rule Spawnpoints = 
    let sps = //[Transform of each Spawnpoint]
      [for a in Spawnpoints2 do
       select a]
    yield sps
    wait false

  Create(pos : Vector3, ps : int) =
  {
  Base = UnityLandscape.Instantiate(pos, ps)
  Spawnpoints = []
  Group = []
  PickUps = []
  }
}

entity PickUp = {
  inherit UnityPickUp
  BonusAndResources : [BonusAndResource]
  BARpos : Vector3

  rule BonusAndResources = 
    let amount = 
      [for a in BonusAndResources do
       where (a.Destroyed = false)
       select a]
    yield amount

  rule BonusAndResources = 
    wait Shuffled.Count > 0
    let p0 = BARpos
    let p1 = BARpos - new Vector3(2.0f,0.0f,0.0f)
    let p2 = BARpos + new Vector3(2.0f,0.0f,0.0f)
    let p3 = BARpos - new Vector3(4.0f,0.0f,0.0f)
    let plist = [p0;p1;p2;p3]
    let Slist = Shuffled
    let BAR = 
      [for a in [0..3] do
       select (new BonusAndResource(plist.[a], Slist.[a]))]
    yield BAR
    wait false

  rule Shuffled = 
    let BARlist = ["AmmoBox";"Crossed Wrenches Red";"Medipack Red";"Battery Black";"Jerry Can Green";"Lightning Blue";"Arrows Green";"Bomb Red";"Shield Metal";"Star Red"]
    yield BARlist
    wait false

  Create(pos : Vector3) = 
  {
    BARpos = pos
    BonusAndResources = []
  }
}
entity BonusAndResource = {
  inherit UnityBonusResource
  NameOfBoR : string
  Active : bool

  rule Active, Destroyed = 
    if collids then 
      yield true, false
      yield true, true

  Create(pos : Vector3, bonus : string) = 
  {
    Base = UnityBonusResource.Instantiate(pos,bonus)
    NameOfBoR = bonus
    Active = false;
  }
}
entity Truck = {
   inherit TruckScript
   Fuel : float
   AxleInfos : [AxleInfo]
   maxMotorTorque : float
   maxSteeringAngle : float
   cnvAccel : float // has to be a value between 0.0f and 1.0f
   JRotation : float // has to be a value between -1.0f and 1.0f
   Active : bool
   Keyboard : bool

   rule HeadlightLeftOn, HeadlightRightOn = 
     if world.ActiveBoR = "Lightning Blue" then
       yield true, true
       wait 5.0f
       yield false, false
       wait 0.2f
       yield true, true
       wait 0.1f
       yield false, false
       wait 0.3f
       yield true, true
     else 
       yield false, false
   
   rule CenterOfMass = 
     yield new Vector3(1.0f,0.0f,-1.5f)
     wait false

   rule InMag, NotInMag = 
     yield world.Pistols.Head.InMagazine, world.Pistols.Head.NotInMagazine

   rule MagazineGUI = 
     yield MagazineGUI

   rule Keyboard = 
      wait Input.GetKeyDown(KeyCode.P)
      yield not Keyboard

   rule cnvAccel = 
      if Keyboard then
        yield Input.GetAxis("Vertical")
      else
        if Acceleration <> 0.0f then 
          yield Acceleration
        else
          yield BrakeAndReverse * -1.0f

   rule JRotation = 
      if Keyboard then
        yield Input.GetAxis("Horizontal")
      else
        yield Steering

   rule Fuel = 
     if world.ActiveBoR = "Jerry Can Green" then 
       Debug.Log("Fuel = "+Fuel)
       yield Fuel + 2000.0f

   Create()=
    {
      Base = TruckScript.Instantiate()
      maxMotorTorque = 250.0f
      maxSteeringAngle = 50.0f
      AxleInfos = [new AxleInfo(FrontLeftWheel,FrontRightWheel,true,true);new AxleInfo(RearLeftWheel,RearRightWheel,true,false)] // FWD
      Fuel = 4000.0f // gas liters
      cnvAccel = 0.0f
      JRotation = 0.0f
      Active = true;
      Keyboard = false;
    }
}

entity AxleInfo = {

  leftWheel : WheelCollider
  rightWheel : WheelCollider
  motor : bool
  steering : bool

  rule leftWheel.steerAngle, rightWheel.steerAngle =
    wait steering
    let steeringAngle = world.Jeep.maxSteeringAngle * world.Jeep.JRotation
    if world.Jeep.cnvAccel > 0.0f then
      if ((steeringAngle > 0.001f  && (world.Jeep.RotationY > 30.0f  && world.Jeep.RotationY < 120.0f)) || 
          (steeringAngle < -0.001f && (world.Jeep.RotationY > 200.0f && world.Jeep.RotationY < 330.0f))) then 
        yield 0.0f,0.0f
      else
        yield steeringAngle, steeringAngle
    if world.Jeep.cnvAccel < 0.0f then
      if ((steeringAngle > 0.001f && (world.Jeep.RotationY > 200.0f && world.Jeep.RotationY < 330.0f)) || 
          (steeringAngle < -0.001f && (world.Jeep.RotationY > 30.0f && world.Jeep.RotationY < 120.0f))) then 
        yield 0.0f,0.0f
      else
    yield steeringAngle, steeringAngle

  rule leftWheel.motorTorque, rightWheel.motorTorque, world.Jeep.Fuel =
    if world.Jeep.Fuel > 0.99f then
      if (world.Jeep.Active && world.Jeep.cnvAccel <> 0.0f) && (leftWheel.isGrounded || rightWheel.isGrounded) then
        let dir = world.Jeep.cnvAccel
        let speed = world.Jeep.maxMotorTorque * world.Jeep.cnvAccel * -1.0f
        if (world.ActiveBoR = "Arrows Green") then 
          yield leftWheel.motorTorque, rightWheel.motorTorque, world.Jeep.Fuel
          .| (world.Jeep.cnvAccel <> dir) =>
            yield speed, speed, world.Jeep.Fuel - 1.0f
          .| _ =>
            yield speed * 10.0f, speed * 10.0f, world.Jeep.Fuel
            wait 2.0f
        else
          yield speed, speed, world.Jeep.Fuel - 1.0f
      else
        yield 0.0f,0.0f, world.Jeep.Fuel
    else
      yield 0.0f,0.0f,0.0f

  Create(lW : WheelCollider, rW : WheelCollider, m : bool, s: bool)=
  {
    leftWheel = lW
    rightWheel = rW
    motor = m
    steering = s
  }
}
*)
entity Zombie = {
  inherit UnityZombie
  Life : float
  bodyPart : string

  rule bodyPart =
    

  rule Destroyed = 
    wait dead2
    wait 0.8f
    yield true

  rule Life, CollisionDamage =
    if (CollisionDamage <> 0.0f) then
      Debug.Log("Collided zombie HP before:" + Life)
      yield Life - (CollisionDamage * 4.0f), 0.0f
      Debug.Log("Collided zombie HP after:" + Life)

  rule CollisionDamage =
    yield CollisionDamage

  (*rule Life = 
    if ((world.Pistols.Head.GunController.Trigger || Input.GetMouseButtonDown(0) && OnMouseOver )) then
      if Life > 0.49f then 
        yield Life - 40.0f
      else
	      yield 0.0f*) 

  (*rule Life = 
    wait Input.GetMouseButtonDown(0)
    if (world.Jeep.Value.Active) then
      if (OnMouseOver || IsHit) then
        if (not world.Pistols.Head.Automatic) then
          if (world.Pistols.Head.GunController.Trigger || Input.GetMouseButtonDown(0)) then
            if Life > 0.49f then 
              yield Life - world.Pistols.Head.DamagePerBullet
            else
	            yield 0.0f
        else
          if (world.Pistols.Head.GunController.Shot) then
            if Life > 0.49f then
              yield Life - world.Pistols.Head.DamagePerBullet
            else
              yield 0.0f*)

 (* rule Life =
    if (hitBodyPart )*)

  rule shot, dead2 = 
    if Life < 0.0f then
      yield true, true

  Create(trans : Transform) = 
  {
  Base = UnityZombie.Find(trans)
  Life = 100.0f // healthpoints
  }
}