module Landscape

open "UnityEngine.dll"
open UnityEngine

entity Gasstation = {
  inherit UnityGasstation

  //new equipment when new jeep
  //wait world.Jeep.Value.CollisionWithModel

  rule world.Jeep.Value.Destroyed, world.Jeep, world.Jeep.Value.CollisionWithModel, Destroyed = 
    wait world.Jeep.Value.CollisionWithModel
    let pos = modely.transform.position
    let newt = new Truck("zpickup", pos, false, [4;2;1;3])
    yield true, Some (newt), false, true
    yield world.Jeep.Value.Destroyed, world.Jeep, world.Jeep.Value.CollisionWithModel, Destroyed

  rule world.Jeep.Value.CollisionWithModel = 
    yield world.Jeep.Value.CollisionWithModel

  Create(ps : Vector3) = {
  Base = UnityGasstation.Instantiate(ps)
  }
}

entity Landscape = { //here are the zombies created and destroyed after a frame
  inherit UnityLandscape
  Group : [GroupZombie]
  PickUps : [PickUp]
  Spawnpoints : [Transform]

  rule Group, PickUps, Spawnpoints = // spawning multiple groups on a single landscape
    wait Spawnpoints.Count > 0
    let random_spawnp = Random.Range(0,4) 
    let random_pickup = Random.Range(0,4)
    if random_spawnp <> random_pickup then
      let sps = Spawnpoints.[random_spawnp]
      let sps_pos = sps.position
      let rpu = Spawnpoints.[random_pickup]
      let rpu_pos = rpu.position
      yield [new GroupZombie(sps_pos)], [new PickUp(rpu_pos)], []
      wait false
    else 
      let sps1 = Spawnpoints.[1]
      let sps_pos1 = sps1.position
      let rpu1 = Spawnpoints.[2]
      let rpu_pos1 = rpu1.position
      yield [new GroupZombie(sps_pos1)], [new PickUp(rpu_pos1)], []
      wait false

  rule Spawnpoints = 
    let sps = 
      [for a in Spawnpoints2 do
       select a]
    yield sps
    wait false

  Create(pos : Vector3, ps : int) =
  {
  Base = UnityLandscape.Instantiate(pos, ps)
  Spawnpoints = []
  Group = []
  PickUps = []
  }
}

entity PickUp = {
  inherit UnityPickUp
  BonusAndResources : [BonusAndResource]
  BARpos : Vector3

  rule BonusAndResources = 
    let amount = 
      [for a in BonusAndResources do
       where (a.Destroyed = false)
       select a]
    yield amount

  rule BonusAndResources = 
    wait Shuffled.Count > 0
    let p0 = BARpos + new Vector3(0.0f,1.0f,0.0f)
    let p1 = BARpos - new Vector3(2.0f,-1.0f,0.0f)
    let p2 = BARpos + new Vector3(2.0f,1.0f,0.0f)
    let p3 = BARpos - new Vector3(4.0f,-1.0f,0.0f)
    let plist = [p0;p1;p2;p3]
    let Slist = Shuffled
    let BAR = 
      [for a in [0..3] do
       select (new BonusAndResource(plist.[a], Slist.[a]))]
    yield BAR
    wait false

  rule Shuffled = 
    let BARlist = ["AmmoBox";"Crossed Wrenches Red";"Medipack Red";"Battery Black";"Jerry Can Green";"Lightning Blue";"Arrows Green";"Bomb Red";"Shield Metal";"Star Red"]
    yield BARlist
    wait false

  Create(pos : Vector3) = 
  {
    BARpos = pos
    BonusAndResources = []
  }
}
entity BonusAndResource = {
  inherit UnityBonusResource
  NameOfBoR : string
  Active : bool

  rule Active, Destroyed = 
    if collids then 
      yield true, false
      yield true, true

  Create(pos : Vector3, bonus : string) = 
  {
    Base = UnityBonusResource.Instantiate(pos,bonus)
    NameOfBoR = bonus
    Active = false;
  }
}