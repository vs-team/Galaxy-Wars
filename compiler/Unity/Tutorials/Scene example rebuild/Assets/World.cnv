module Game

open "UnityEngine.dll"
open UnityEngine

worldEntity World = {
  inherit UnityLandscape
  Landscapes : [Landscape]
  Jeep : Option<Truck>
  Zombies : [Zombie] // are created in the landscape in groups
  GUIpanel : GUI
  ActiveBoR : string
  Counter : int
  Gasstations : [Gasstation]
  Players : [Player]

  rule Zombies = 
    let groups = 
      [for a in Landscapes do
       for b in a.Group do
       select b]
    let zombiegroup = 
      [for a in groups do
       for c in a.ZombieFollowers do
	     select c]
    let groupleader = 
      [for a in groups do
       where a.ZombieLeader.IsSome
       let z = a.ZombieLeader.Value
       select z]
    let group = groupleader @ zombiegroup
    if group.Count > 0 then
      yield group @ Zombies
  
  rule Zombies = 
    let zmbies = 
      [for a in Zombies do
       where (a.Destroyed = false)
       select a]
    //Debug.Log("zombies count = "+zmbies.Count)
    yield zmbies

  rule ActiveBoR = 
    if ActiveBoR = "Crossed Wrenches Red" then
      let resourcelist = ["Medipack Red";"Battery Black";"Jerry Can Green"]
      let rnd = Random.Range(0,3)
      yield resourcelist.[rnd]
  
  rule ActiveBoR = 
    let a = 
      [for a in Landscapes do
       for b in a.PickUps do
       for c in b.BonusAndResources do
       where c.Active
       select (c.NameOfBoR)]
    if a.Count > 0 then
      Debug.Log(a.Head)
      yield a.Head
      yield ""

  rule Landscapes, Counter, Gasstations  = 
    let ls = 
      [for a in Landscapes do
       select a]
    let gs = 
      [for b in Gasstations do
       select b]
    if (ls.Count > 0) then
      let randr = Random.Range(1,5) 
      if gs.Count > 0 then 
        let Headpos = if (ls.Head.Position.z < gs.Head.Position.z) then ls.Head.Position else gs.Head.Position
        if Counter > 7 then
          yield Landscapes, 0, new Gasstation(new Vector3(0.0f,0.0f, Headpos.z - 80.0f)) :: Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)
        else
          yield (new Landscape(new Vector3(0.0f,0.0f,Headpos.z - 80.0f), randr)) :: Landscapes, Counter + 1, Gasstations
          yield Landscapes, Counter, Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)
      else 
        let Headpos = ls.Head.Position
        if Counter > 7 then
          yield Landscapes, 0, new Gasstation(new Vector3(0.0f,0.0f, Headpos.z - 80.0f)) :: Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)
        else
          yield (new Landscape(new Vector3(0.0f,0.0f,Headpos.z - 80.0f), randr)) :: Landscapes, Counter + 1, Gasstations
          yield Landscapes, Counter, Gasstations
          wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)

  Create() =
    let truk = new Truck("zpickup", new Vector3(0.0f,-6.0f,0.0f), false, [4;2;1;3])
    {
     Landscapes = [new Landscape(new Vector3(0.0f,0.0f,-160.0f), 1); new Landscape((Vector3.zero), (2))] 
     Jeep = Some truk
     Zombies = []
     GUIpanel = new GUI()
     ActiveBoR = ""
     Counter = 3
     Gasstations = [new Gasstation(new Vector3(0.0f,0.0f, -80.0f))]
     Players = [new Player(1)]
    }
}
entity Player = {
  Num : int
  Equip : Equipment
  ref Controllers : [ControllerRazor]

  Create(id : int) = 
  {
    Num = id
    Equip = new Equipment([80;20], 20)
    Controllers = [new ControllerRazor("Hydra1 - Right"); new ControllerRazor("Hydra1 - Left")]
  }
}

entity Equipment = {
  inherit UnityEquipment
  ref AllGuns : [Gun]
  ActiveGuns : [Gun]
  ref NotActiveGuns : [Gun]
  GunControllerPressed : Option<Gun>
  ActiveFlashs : [Light]
  ref NotActiveFlashs : [Light]
  ref AllFlashs : [Light]
  LightControllerPressed : Option<Light>

  rule NotActiveFlashs, sap = 
    wait GunControllerPressed.IsSome || LightControllerPressed.IsSome
    let j = 
      [for a in AllFlashs do
       where (not ActiveFlashs.Contains(a))
       select a]
    let rig = 
      [for a in ActiveFlashs do
       where (a.LightController.JoystickName <> "Hydra1 - Left")
       select a]
    let right = if rig.Count > 0 then true else false
    let lef = 
      [for a in ActiveFlashs do
       where (a.LightController.JoystickName <> "Hydra1 - Right")
       select a]
    let left = if lef.Count > 0 then true else false
    yield j, [right;left]

  rule NotActiveGuns, asdf = 
    wait GunControllerPressed.IsSome || LightControllerPressed.IsSome
    let r = 
      [for a in AllGuns do
       where (not ActiveGuns.Contains(a))
       select a]
    let fdsa = 
      [for a in r do
       select ("Nummer:" + a.GunNumber + " Controller:" + a.GunController.JoystickName)]
    yield r, fdsa

  rule ActiveGuns, ActiveFlashs = 
    wait GunControllerPressed.IsSome || LightControllerPressed.IsSome
    let Joystickname = if (GunControllerPressed.IsSome) then GunControllerPressed.Value.GunController.JoystickName else LightControllerPressed.Value.LightController.JoystickName
    let Operation = if (GunControllerPressed.IsSome) then GunControllerPressed.Value.GunController.ECB else LightControllerPressed.Value.LightController.ECB
    let GunNumber = if (GunControllerPressed.IsSome) then GunControllerPressed.Value.GunNumber else 0
    let OldActiveGun = 
      [for a in ActiveGuns do
       where (a.GunController.JoystickName <> Joystickname)
       select a]
    let OldActiveFlash = 
      [for a in ActiveFlashs do
       where (a.LightController.JoystickName <> Joystickname)
       select a]
    if GunControllerPressed.IsSome then
      let changingjoystick = 
        [for a in AllGuns do
        where (a.GunController.JoystickName = Joystickname)
        select a]
      let Listsize = changingjoystick.Count
      
      if Operation = "other" then
        let changingLight = 
          [for a in AllFlashs do
           where (a.LightController.JoystickName = Joystickname)
           select a]
        if OldActiveFlash.Count > 0 then
          Debug.Log("Max 1 flashlight allowed")
          yield ActiveGuns, [OldActiveFlash.Head]
        else
          let NewActiveFlash = changingLight.Head
          yield OldActiveGun, [NewActiveFlash]

      if Operation = "next" then
        let nextGunNumber = (GunNumber + 1) % Listsize
        let check = 
          [for a in ActiveGuns do
           where (a.GunNumber = nextGunNumber)
           select a]
        if check.Count > 0 then
          let othernumber = (GunNumber + 2) % Listsize
          let newActiveGun = //newActiveGun
            [for a in changingjoystick do 
             where (a.GunNumber = othernumber)
             select a]
          if Joystickname = TransformHR.name then
            if OldActiveGun.Count > 0 then
              yield [newActiveGun.Head;OldActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs
          else 
            if OldActiveGun.Count > 0 then
              yield [OldActiveGun.Head;newActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs
        else
          let newActiveGun = //newActiveGun
            [for a in changingjoystick do 
             where (a.GunNumber = nextGunNumber)
             select a]
          if Joystickname = TransformHR.name then
            if OldActiveGun.Count > 0 then
              yield [newActiveGun.Head;OldActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs
          else 
            if OldActiveGun.Count > 0 then
              yield [OldActiveGun.Head;newActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs

      if Operation = "prev" then
        let prevGunNumber = ((GunNumber + Listsize) - 1) % Listsize
        let check = 
          [for a in ActiveGuns do
           where (a.GunNumber = prevGunNumber)
           select a]
        if check.Count > 0 then
          let othernumber = ((GunNumber + Listsize) - 2) % Listsize
          let newActiveGun = 
            [for a in changingjoystick do 
             where (a.GunNumber = othernumber)
             select a]
          if Joystickname = TransformHR.name then
            if OldActiveGun.Count > 0 then
              yield [newActiveGun.Head;OldActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs
          else 
            if OldActiveGun.Count > 0 then
              yield [OldActiveGun.Head;newActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs
        else
          let newActiveGun = 
            [for a in changingjoystick do 
             where (a.GunNumber = prevGunNumber)
             select a]
          if Joystickname = TransformHR.name then
            if OldActiveGun.Count > 0 then
              yield [newActiveGun.Head;OldActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs
          else 
            if OldActiveGun.Count > 0 then
              yield [OldActiveGun.Head;newActiveGun.Head], ActiveFlashs
            else
              yield [newActiveGun.Head], ActiveFlashs

    if LightControllerPressed.IsSome then
      let changingjoystick = 
        [for a in AllFlashs do
        where (a.LightController.JoystickName = Joystickname)
        select a]
      let currActiveGunNumber = 
        [for a in ActiveGuns do
         select a.GunNumber]
      if currActiveGunNumber.Count > 0 then
        let newActiveGun = 
          [for a in NotActiveGuns do
           where ((a.GunController.JoystickName = Joystickname) && a.GunNumber <> currActiveGunNumber.Head)
           select a]
        yield [OldActiveGun.Head;newActiveGun.Head], []
      else 
        let NAG = 
          [for a in NotActiveGuns do
           where (a.GunController.JoystickName = Joystickname)
           select a]
        yield [NAG.Head], [OldActiveFlash.Head]

  rule GunControllerPressed, LightControllerPressed = 
    let q = 
      [for a in ActiveGuns do
       where (a.GunController.ECB <> "")
       select a]
    // Light can only change to gun. no other flashlights possible
    let j = 
      [for a in ActiveFlashs do
       where (a.LightController.ECB = "other")
       select a]
    if q.Count > 0 && not (j.Count > 0) then
      yield Some q.Head, None
    if j.Count > 0 && not (q.Count > 0) then
      yield None, Some j.Head
    else
      yield None, None

  rule ActiveGuns, NotActiveGuns, AllGuns, asdf, ActiveFlashs, NotActiveFlashs, AllFlashs = // start!! gun is right, flash is left
    let pl = world.Players.Head.Controllers
    
    // guns
    let j = [TransformHR.name;TransformHL.name]
    let x = 
      [for a in [0..(HR.Count - 1)] do
       select (new Gun(a,pl.Head,j.Head))]
    let y = 
      [for a in [0..(HL.Count - 1)] do
       select (new Gun(a,pl.[1],j.[1]))]
    let AllGunslist = x @ y
    let AG = [AllGunslist.[0]]
    let NotAG = 
      [for a in AllGunslist do
       where (not AG.Contains(a))
       select a]

    // flashlights
    let z = [flashL.name;flashR.name]
    let AF = [new Light(pl.[1],z.[1])]
    let NAF = [new Light(pl.[0],z.[0])]
    let AllF = AF @ NAF

    // yields
    yield AG, NotAG, AllGunslist, [], AF, NAF, AllF
    let fdsa = 
      [for a in NotAG do
       select ("Nummer:" + a.GunNumber + " Controller:" + a.GunController.JoystickName)]
    yield ActiveGuns, NotActiveGuns, AllGuns, fdsa, ActiveFlashs, NotActiveFlashs, AllFlashs
    wait false

  Create(bulls : [int], flashs : int) = 
  {
    Base = UnityEquipment.Instantiate()
    ActiveGuns = []
    NotActiveGuns = []
    GunControllerPressed = None
    LightControllerPressed = None
    AllGuns = []
    ActiveFlashs = []
    NotActiveFlashs = []
    AllFlashs = []
  }
}

entity ControllerRazor= {
  inherit SixenseHand
  other : bool
  next : bool
  prev : bool
  JoystickName : string
  ECB : string
  
  rule Shot = 
    if (Trigger || Input.GetMouseButtonDown(0)) then
      yield true
    else
      yield false

  rule Trigger =
    yield Trigger

  rule Bumper =
    yield Bumper

  rule ECB = 
    if prev then
      yield "prev"
    if next then
      yield "next"
    if other then
      yield "other"
    else
      yield ""

  rule other = 
    wait Twee
    yield true
    yield true
    yield false
    wait not Twee

  rule prev = 
    wait Drie
    yield true
    yield true
    yield false
    wait not Drie

  rule next = 
    wait Vier
    yield true
    yield true
    yield false
    wait not Vier

  Create(joystickName : string) = 
  {
    Base = SixenseHand.Instantiate(joystickName)
    JoystickName = joystickName
    next = false
    other = false
    prev = false
    ECB = ""
  }
}

entity Gun = {
  inherit UnityGun
  GunController : ControllerRazor
  Reloading : bool
  ReloadDuration : float
  MagazineSize : int
  Automatic : bool
  DamagePerBullet : float
  NotInMagazine : int
  InMagazine : int
  TypeWeapon : string
  GunPower : float 
  GunNumber : int

  rule Shoot, InMagazine = 
   wait GunController.Shot
   if (InMagazine > 0 && not Reloading) then
     if (not Automatic) then
       yield true, InMagazine - 1
       yield false, InMagazine
     else
       while (GunController.Shot && InMagazine > 0) do
         yield true, InMagazine - 1
         yield false, InMagazine
         wait 0.05f // Rate of fire

  rule NotInMagazine = 
    if world.ActiveBoR = "AmmoBox" then 
      yield NotInMagazine + 50

  rule Reloading, NotInMagazine, InMagazine = 
    if ((Input.GetKey(KeyCode.R) || InMagazine = 0) && NotInMagazine > 0) then
      yield true, NotInMagazine, InMagazine
      wait (ReloadDuration)
      if MagazineSize > NotInMagazine then // clip can't be fulled completely
        yield false, 0, NotInMagazine
      else 
        let changed = (MagazineSize - InMagazine)
        yield false, NotInMagazine - changed, MagazineSize // fill clip completely

  rule MagazineGUI = 
    yield ""

  rule InMag, NotInMag = 
    yield InMagazine, NotInMagazine

  rule Reloading = 
    if Input.GetKey(KeyCode.C) then
      yield false

  rule GunForce =
    //Debug.Log(GunForce)
    yield GunPower 
    wait false

  Create(ind : int, GC : ControllerRazor, tr : string) = 
  let autom = if (ind <> 0) then false else true
  let stlist =             ["MachineGun";"Pistol" ;"ShotGun";"Revolver" ; "Bazooka"]
  let InMagList =          [50          ; 20      ;    5    ; 6         ; 0]
  let NotInMagList =       [850         ; 200     ;   60    ; 90        ; 16]
  let ClipSizeList =       [150         ; 20      ;    5    ; 6         ; 1]
  let ReloadDurationList = [7.0f        ; 3.0f    ;  4.0f   ; 2.0f      ; 5.0f]
  let DamageList =         [40.0f       ; 75.0f   ; 135.0f  ; 100.0f    ; 400.0f]
  let GunPowerList =       [2.4f     ; 0.8f  ; 2.4f   ; 1.8f    ; 5.0f  ]
  let nam = stlist.[ind]
  {
    Base = UnityGun.Instantiate(nam, tr)
    TypeWeapon = nam
    GunController = GC
    NotInMagazine = NotInMagList.[ind]
    Reloading = false
    MagazineSize = ClipSizeList.[ind]
    InMagazine = InMagList.[ind]
    ReloadDuration = ReloadDurationList.[ind]
    Automatic = autom
    DamagePerBullet = DamageList.[ind]
    GunPower = GunPowerList.[ind]
    GunNumber = ind
  }
}

entity Bullet = {
  inherit UnityBullet
  cnt : float 
  transforw : Vector3

  rule Frce, cnt = 
    while cnt < 40.0f do
      yield transforw, cnt + 10.0f
    wait false

  Create(pos : Vector3, directi : Vector3) = 
  {
    Base= UnityBullet.Instantiate(pos, "bullet")
    cnt = 0.0f
    transforw = directi
  }
}

entity Gasstation = {
  inherit UnityGasstation

  Create(ps : Vector3) = {
  Base = UnityGasstation.Instantiate(ps)
  }

}

entity GroupZombie = { 
  inherit UnityGroup
  ZombieFollowers : [Zombie]
  ZombieLeader : Option<Zombie>

  rule ZombieLeader = 
    let leader = new Zombie(U_ZombieLeader)
    yield Some leader
    yield None
    wait false

  rule ZombieFollowers = 
    let z = 
      [for a in U_Zombies do
       select (new Zombie(a))] 
    yield z
    yield []
    wait false

  Create(sps : Vector3) =
  {
    Base = UnityGroup.Instantiate(sps)
    ZombieFollowers = []
    ZombieLeader = None
  }
}

entity Light = {
  LightController : ControllerRazor
  Battery : float
  Active : bool
  
  rule Battery = 
     if world.ActiveBoR = "Battery Black" then 
       Debug.Log("Battery = "+Battery)
       yield Battery + 50.0f
    
  rule Battery = 
    //Debug.Log("Battery: " + Battery)
    if Active && Battery > 0.49f then
      yield Battery - 0.5f
    else
      yield Battery

  rule Active =
    yield LightController.Trigger

  Create(LC : ControllerRazor, tr : string) = 
  {
    LightController = LC
    Battery = 100.0f
    Active = false
  }
}

entity GUI = { //panel. Each wall contains the same info?
  inherit GUIBarScript

  Create() = 
  {
    Base = GUIBarScript.Find()
  }

}

entity Landscape = { //here are the zombies created and destroyed after a frame
  inherit UnityLandscape
  Group : [GroupZombie]
  PickUps : [PickUp]
  Spawnpoints : [Transform]

  rule Group, PickUps, Spawnpoints = // spawning multiple groups on a single landscape
    wait Spawnpoints.Count > 0
    let random_spawnp = Random.Range(0,4) 
    let random_pickup = Random.Range(0,4)
    if random_spawnp <> random_pickup then
      let sps = Spawnpoints.[random_spawnp]
      let sps_pos = sps.position
      let rpu = Spawnpoints.[random_pickup]
      let rpu_pos = rpu.position
      yield [new GroupZombie(sps_pos)], [new PickUp(rpu_pos)], []
      wait false
    else 
      let sps1 = Spawnpoints.[1]
      let sps_pos1 = sps1.position
      let rpu1 = Spawnpoints.[2]
      let rpu_pos1 = rpu1.position
      yield [new GroupZombie(sps_pos1)], [new PickUp(rpu_pos1)], []
      wait false

  rule Spawnpoints = 
    let sps = //[Transform of each Spawnpoint]
      [for a in Spawnpoints2 do
       select a]
    yield sps
    wait false

  Create(pos : Vector3, ps : int) =
  {
  Base = UnityLandscape.Instantiate(pos, ps)
  Spawnpoints = []
  Group = []
  PickUps = []
  }
}

entity PickUp = {
  inherit UnityPickUp
  BonusAndResources : [BonusAndResource]
  BARpos : Vector3

  rule BonusAndResources = 
    let amount = 
      [for a in BonusAndResources do
       where (a.Destroyed = false)
       select a]
    yield amount

  rule BonusAndResources = 
    wait Shuffled.Count > 0
    let p0 = BARpos
    let p1 = BARpos - new Vector3(2.0f,0.0f,0.0f)
    let p2 = BARpos + new Vector3(2.0f,0.0f,0.0f)
    let p3 = BARpos - new Vector3(4.0f,0.0f,0.0f)
    let plist = [p0;p1;p2;p3]
    let Slist = Shuffled
    let BAR = 
      [for a in [0..3] do
       select (new BonusAndResource(plist.[a], Slist.[a]))]
    yield BAR
    wait false

  rule Shuffled = 
    let BARlist = ["AmmoBox";"Crossed Wrenches Red";"Medipack Red";"Battery Black";"Jerry Can Green";"Lightning Blue";"Arrows Green";"Bomb Red";"Shield Metal";"Star Red"]
    yield BARlist
    wait false

  Create(pos : Vector3) = 
  {
    BARpos = pos
    BonusAndResources = []
  }
}
entity BonusAndResource = {
  inherit UnityBonusResource
  NameOfBoR : string
  Active : bool

  rule Active, Destroyed = 
    if collids then 
      yield true, false
      yield true, true

  Create(pos : Vector3, bonus : string) = 
  {
    Base = UnityBonusResource.Instantiate(pos,bonus)
    NameOfBoR = bonus
    Active = false;
  }
}
entity TruckStats = {
  Health : float
  MaxSpeed : float
  MaxSteering : float
  Hull : float
  Fuel : float
  isModel : bool
  NotInMagazine : [int]
  InMagazine : [int]
  TypeWeapon : [int]
  AmountOfGunsInTruck : int

  rule AmountOfGunsInTruck =
    yield TypeWeapon.Count

  rule Health, world.Jeep.Value.CarHP2 = 
    if world.ActiveBoR = "Medipack Red" && isModel <> true then
      yield Health + 20.0f, ((Health) / 100.0f)

  rule world.Jeep.Value.CarHP2, Health, world.GUIpanel.HPValue = 
    if isModel <> true then
      let z = world.Jeep.Value.CarHP2
      if (z <> (Health / 100.0f)) then
        yield world.Jeep.Value.CarHP2, (world.Jeep.Value.CarHP2 * 100.0f), world.Jeep.Value.CarHP2
      else
        yield (Health / 100.0f), (world.Jeep.Value.CarHP2 * 100.0f), world.Jeep.Value.CarHP2

  Create(bs : bool, sts : [int]) = 
  let rnd = Random.Range(0,5)
  let HealthList = [50.0f; 60.0f; 75.0f; 80.0f; 100.0f]
  let MaxSpeedList = [10.0f; 10.0f; 10.0f; 15.0f; 20.0f]
  let MaxSteeringList = [5.0f; 10.0f; 10.0f; 20.0f; 15.0f]
  let HullList = [8.0f; 5.0f ; 3.0f ; 4.0f ; 2.0f]
  let FuelList = [12000.0f ; 8000.0f ; 15000.0f ; 6000.0f ; 10000.0f]
  let InMagList =           [50        ; 20 ;    5       ; 6       ; 0]
  let NotInMagList = [       850       ; 200 ;   60      ; 90      ; 16]
  {
    Health = HealthList.[rnd]
    MaxSpeed = MaxSpeedList.[rnd]
    MaxSteering = MaxSteeringList.[rnd]
    Hull = HullList.[rnd] //damage taken by hull
    Fuel = FuelList.[rnd]
    isModel = bs
    TypeWeapon = sts
    NotInMagazine = NotInMagList
    InMagazine = InMagList
    AmountOfGunsInTruck = 0
  }

}

entity Truck = {
   inherit TruckScript
   Fuel : float
   AxleInfos : [AxleInfo]
   maxMotorTorque : float
   maxSteeringAngle : float
   cnvAccel : float // has to be a value between 0.0f and 1.0f
   JRotation : float // has to be a value between -1.0f and 1.0f
   Keyboard : bool
   isModel : bool
   Active : bool
   Stats : TruckStats

   rule HeadlightLeftOn, HeadlightRightOn = 
     if world.ActiveBoR = "Lightning Blue" then
       yield true, true
       wait 5.0f
       yield false, false
       wait 0.2f
       yield true, true
       wait 0.1f
       yield false, false
       wait 0.3f
       yield true, true
       wait 0.1f
       yield false, false

   rule Keyboard = 
      wait Input.GetKeyDown(KeyCode.P)
      yield not Keyboard

   rule cnvAccel = 
      if Keyboard then
        yield Input.GetAxis("Vertical")
      else
        if Acceleration <> 0.0f then 
          yield Acceleration
        else
          yield BrakeAndReverse * -1.0f

   rule JRotation = 
      if Keyboard then
        yield Input.GetAxis("Horizontal")
      else
        yield Steering

   rule Fuel = 
     if not isModel then 
       if world.ActiveBoR = "Jerry Can Green" then 
         Debug.Log("Fuel = "+Fuel)
         yield Fuel + 2000.0f

   rule Active = 
     yield true
     wait false

   rule AxleInfos = 
     yield [new AxleInfo(FrontLeftWheel,FrontRightWheel,true,true);new AxleInfo(RearLeftWheel,RearRightWheel,true,false)]

   Create(nm : string, pos : Vector3, ModelIs : bool, ints : [int]) = 
    {
      Active = false
      isModel = ModelIs
      Base = TruckScript.Instantiate(nm, pos)
      maxMotorTorque = 250.0f
      maxSteeringAngle = 50.0f
      AxleInfos = []
      Fuel = 80000.0f // gas liters
      cnvAccel = 0.0f
      JRotation = 0.0f
      Keyboard = false;
      Stats = new TruckStats(ModelIs, ints)
    }
}

entity AxleInfo = {

  leftWheel : WheelCollider
  rightWheel : WheelCollider
  motor : bool
  steering : bool

  rule steering = 
    yield steering

  rule leftWheel.steerAngle, rightWheel.steerAngle =
    wait steering
    if not world.Jeep.Value.isModel then
      let steeringAngle = world.Jeep.Value.maxSteeringAngle * world.Jeep.Value.JRotation
      if world.Jeep.Value.cnvAccel > 0.0f then
        if ((steeringAngle > 0.001f  && (world.Jeep.Value.RotationY > 30.0f  && world.Jeep.Value.RotationY < 120.0f)) || 
            (steeringAngle < -0.001f && (world.Jeep.Value.RotationY > 200.0f && world.Jeep.Value.RotationY < 330.0f))) then 
          yield 0.0f,0.0f
        else
          yield steeringAngle, steeringAngle
      if world.Jeep.Value.cnvAccel < 0.0f then
        if ((steeringAngle > 0.001f && (world.Jeep.Value.RotationY > 200.0f && world.Jeep.Value.RotationY < 330.0f)) || 
            (steeringAngle < -0.001f && (world.Jeep.Value.RotationY > 30.0f && world.Jeep.Value.RotationY < 120.0f))) then 
          yield 0.0f,0.0f
        else
          yield steeringAngle, steeringAngle

  rule leftWheel.motorTorque, rightWheel.motorTorque, world.Jeep.Value.Fuel =
    if not world.Jeep.Value.isModel then
      if world.Jeep.Value.Fuel > 0.99f then
        if ((world.Jeep.Value.cnvAccel <> 0.0f) && (leftWheel.isGrounded || rightWheel.isGrounded)) then
          let dir = world.Jeep.Value.cnvAccel
          let speed = world.Jeep.Value.maxMotorTorque * world.Jeep.Value.cnvAccel * -1.0f
          if (world.ActiveBoR = "Arrows Green") then 
            yield leftWheel.motorTorque, rightWheel.motorTorque, world.Jeep.Value.Fuel
            .| (world.Jeep.Value.cnvAccel <> dir) =>
              yield speed, speed, world.Jeep.Value.Fuel - 1.0f
            .| _ =>
              yield speed * 10.0f, speed * 10.0f, world.Jeep.Value.Fuel
              wait 2.0f
          else
            yield speed, speed, world.Jeep.Value.Fuel - 1.0f
        else
          yield 0.0f,0.0f, world.Jeep.Value.Fuel
      else
        yield 0.0f,0.0f,0.0f

  Create(lW : WheelCollider, rW : WheelCollider, m : bool, s: bool)=
  {
    leftWheel = lW
    rightWheel = rW
    motor = m
    steering = s
  }
}

entity Zombie = {
  inherit UnityZombie2
  Life : float 

  (*rule Destroyed = 
    wait dead2
    wait 0.8f
    yield true*)

  rule Life, CollisionDamage =
    if (CollisionDamage <> 0.0f) then
      Debug.Log("Collided zombie HP before:" + Life)
      yield Life - (CollisionDamage * 6.0f), 0.0f
      Debug.Log("Collided zombie HP after:" + Life)

  rule CollisionDamage =
    yield CollisionDamage

  rule Dead = 
    if (Life <= 0.0f) then
      yield true
      wait false

  Create(trans : Transform) = 
  {
  Base = UnityZombie2.Find(trans)
  Life = 100.0f // healthpoints
  }
}