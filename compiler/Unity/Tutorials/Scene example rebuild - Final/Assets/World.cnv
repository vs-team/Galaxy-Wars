module Game

open "UnityEngine.dll"
open UnityEngine

open Truck
open Landscape
open Player
open Zombie

worldEntity World = {
  inherit UnityLandscape 
  Gasstations : [Gasstation]
  Landscapes : [Landscape]
  Jeep : Option<Truck>
  Zombies : [Zombie] // are created in the landscape in groups
  Gui : [Guibar]
  ActiveBoR : string
  Counter : int  
  Players : [Player]
  Score : int
  W_Refill_Resources : bool
  ZombiegroupDest : Option<ZombieGroupDestroyer>
  LastAddedGasStationPosition : Vector3

  rule W_Refill_Resources = 
    let j = 
      [for a in Gasstations do
       where a.RepairZonE.Refill_Resources
       select a]
    let t = if j.Count > 0 then true else false
    if t then
      yield true
    else
      yield false

  rule Score = 
    wait Jeep.IsSome
    let x = Jeep.Value.MultiplierBonus
    if (x > 1.1f) then // once in 2 frames. if statement check takes a frame
      yield Score + 1

  rule Score = 
    yield Score + 1

  rule Zombies = 
    let groups = 
      [for a in Gasstations do
       for b in a.GroupZombies do
       select b]
    let zombiegroup = 
      [for a in groups do
       for c in a.ZombieFollowers do
	     select c]
    if zombiegroup.Count > 0 then
      yield zombiegroup @ Zombies

  rule Zombies = 
    let groups = 
      [for a in Landscapes do
       for b in a.Group do
       select b]
    let zombiegroup = 
      [for a in groups do
       for c in a.ZombieFollowers do
	     select c]
    if zombiegroup.Count > 0 then
      yield zombiegroup @ Zombies
  
  rule Zombies = 
    let zmbies = 
      [for a in Zombies do
       where (a.Destroyed = false)
       select a]
    yield zmbies

  rule ZombiegroupDest, Landscapes = 
    wait 1.0f
    let x = 
      [for a in Landscapes do
       where (Vector3.Distance (a.Position, Jeep.Value.Position) > 400)
       select a]
    if (x.Count > 0) then
      let q = 
        [for a in Landscapes do
         where (Vector3.Distance (a.Position, Jeep.Value.Position) < 400)
         select a]
      let g = x.Head.transform
      let j = new ZombieGroupDestroyer(g.position.z, Jeep.Value.Position)
      yield Some j, q
      wait dt
      yield None, Landscapes  
    else
      let z = new ZombieGroupDestroyer(10.0f, Jeep.Value.Position)
      yield Some z, Landscapes
      wait dt
      yield None, Landscapes

  rule world.Jeep.Value.Fuel, world.Jeep.Value.Stats.Health, world.Jeep.Value.CarHP2 = 
    if ActiveBoR = "Crossed Wrenches Red" then
      yield world.Jeep.Value.Fuel + 4000.0f, world.Jeep.Value.Stats.Health + 20.0f, ((world.Jeep.Value.Stats.Health) / 100.0f)
  
  rule ActiveBoR = 
    let a = 
      [for a in Landscapes do
       for b in a.PickUps do
       for c in b.BonusAndResources do
       where c.Active
       select (c.NameOfBoR)]
    if a.Count > 0 then
      yield a.Head
      yield ""

  rule Landscapes, Counter, Gasstations, LastAddedGasStationPosition = 
    let ls = 
      [for a in Landscapes do
       select a]
    let randr = Random.Range(1,5) 
    if Gasstations.Count > 0 then 
      let Headpos = if (ls.Head.Position.z > LastAddedGasStationPosition.z) then LastAddedGasStationPosition else ls.Head.Position
      if Counter > 9 then
        yield Landscapes, 0, new Gasstation(new Vector3(0.0f,0.0f, Headpos.z - 80.0f)) :: Gasstations, new Vector3(0.0f,0.0f, Headpos.z - 80.0f)
        wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)
      else
        yield (new Landscape(new Vector3(0.0f,0.0f,Headpos.z - 80.0f), randr)) :: Landscapes, Counter + 1, Gasstations, LastAddedGasStationPosition
        yield Landscapes, Counter, Gasstations, LastAddedGasStationPosition
        wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)
    else 
      let Headpos = ls.Head.Position
      if Counter > 9 then
        yield Landscapes, 0, new Gasstation(new Vector3(0.0f,0.0f, Headpos.z - 80.0f)) :: Gasstations, new Vector3(0.0f,0.0f, Headpos.z - 80.0f)
        wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)
      else
        yield (new Landscape(new Vector3(0.0f,0.0f,Headpos.z - 80.0f), randr)) :: Landscapes, Counter + 1, Gasstations, LastAddedGasStationPosition
        yield Landscapes, Counter, Gasstations, LastAddedGasStationPosition
        wait (Vector3.Distance(Headpos, Jeep.Value.Position) < 200.0f)

  rule Gasstations = 
    let gs= 
      [for b in Gasstations do
       where (b.Destroyed <> true)
       select b]
    yield gs

  Create() =
    let truk = new Truck("zpickup", new Vector3(0.0f,-6.99f,0.0f), false, [4;2;1;3])
    {
     Gasstations = []
     Landscapes = [new Landscape(new Vector3(0.0f,0.0f,-160.0f), 1);new Landscape(new Vector3(0.0f,0.0f,-80.0f), 3); new Landscape((Vector3.zero), (2))] 
     Jeep = Some truk
     Zombies = []
     Gui = [new Guibar("HP");new Guibar("Fuel")]
     ActiveBoR = ""
     Counter = 3
     Players = [new Player(1)]
     Score = 0
     W_Refill_Resources = false
     ZombiegroupDest = None
     LastAddedGasStationPosition = new Vector3(0.0f,0.0f,0.0f)
    }
}

entity Guibar = {
  inherit GUIBarScript
  BarType : string

  rule check = 
    if BarType = "Fuel" && world.Jeep.Value.GameOver <> 0 then
      yield true
      wait 0.4f
      yield false
      wait 0.4f
      yield true
      wait 0.4f
      yield false
      wait 0.4f

  rule HPValue = 
    if BarType = "HP" then
      yield world.Jeep.Value.CarHP2
    else
      wait 0.5f
      yield (world.Jeep.Value.Fuel / 10000.0f)

  Create(typ : string) = 
  {
    Base = GUIBarScript.Find(typ)
    BarType = typ
  }
}