module Game

open "UnityEngine.dll"
open UnityEngine

worldEntity World = {
  Landscapes : [Landscape]
  Jeep : Truck

  rule Landscapes  = 
    let a =
      [for e in Landscapes do
       where e.Checkpoint.isEntered
       select e]
    if a.Count > 0 then
      let headOfA = a.Head
      let headOfATransform = headOfA.transform
      let headOfAPosition = headOfATransform.position
      yield new Landscape(new Vector3(0.0f,0.0f,headOfAPosition.z - 240.0f)) :: Landscapes

  rule Landscapes =
    let destroyed_filter =
      [for e in Landscapes do
       where (not e.Destroyed)
       select e]
    yield destroyed_filter

  Create() =
    {
     Jeep = new Truck() 
     Landscapes = [new Landscape(new Vector3(0.0f,0.0f,0.0f));new Landscape(new Vector3(0.0f,0.0f,-80.0f));new Landscape(new Vector3(0.0f,0.0f,-160.0f))]
    }
}

entity Landscape = {
  inherit UnityLandscape
  Zombies	: [Zombie]
  SP : [Transform]
  hasSpawned : bool
  DestroyDistance : float

  rule Zombies = 
    [for a in Zombies do
	   where (not a.Destroyed)
	   select a]

  rule Zombies, hasSpawned = 
    wait (not hasSpawned)
    let SPHP = SP.Head.position 
    yield new Zombie(SPHP) :: Zombies, true

  rule Checkpoint.isEntered =
    wait Checkpoint.isEntered
    yield Checkpoint.isEntered
    yield false

  //rule Destroyed =
    //wait Vector3.Distance(Position,world.Jeep.Position) > DestroyDistance
    //yield true

  rule SP = 
    [for a in Spawnpoints2 do
	   select a]

  Create(StartP : Vector3) = {
  Base = UnityLandscape.Instantiate(StartP)
  Zombies = []
  SP = []
  hasSpawned = false
  DestroyDistance = 500.0f
  }
}

entity Truck = {
   inherit TruckScript

   Velocity : Vector3

   rule Rotation =   // Add rotation constraints to prevent jeep falling over
      yield Rotation

   rule CenterOfMass =
     yield new Vector3(0.0f,0.0f,-0.4f)

   rule AddFors =
     if (Input.GetKey(KeyCode.W)) then
       yield -100.0f
     if (Input.GetKey(KeyCode.S)) then
       yield 100.0f
   
   rule RotateCar =
     if (Input.GetKey(KeyCode.D)) then
       yield new Vector3(0.0f,100.0f,0.0f)

     if (Input.GetKey(KeyCode.A)) then
       yield new Vector3(0.0f,-100.0f,0.0f)

   Create()=
    {
      Velocity = Vector3(0.0f, 0.0f, 0.0f)
      Base = TruckScript.Instantiate()
    }
}
entity Zombie = {
  inherit UnityZombie
  JeepPos : Vector3

  rule Position, speed, Destroyed = 
    if Destroyed = false then
      if Position = JeepPos then // collision
        yield new Vector3(0.0f,0.0f,0.0f), 0.0f, false
      else // not in range
        yield Position, 1.0f*dt*0, false

  rule currenta,targeta = Position, JeepPos

  rule Rotation, Destroyed = 
    if Destroyed = false then
      if Position = JeepPos then
        yield new Quaternion(0.0f,0.0f,0.0f,0.0f), false
      else
        yield Rotation, false

  //rule JeepPos = world.Jeep.Position

  //rule collision =
    //if Vector3.Distance(world.Jeep.Position,Position) < 4.0f then
      //yield true
    //else
      //yield false

  rule shot, Destroyed = 
    if OnMouseOver then
      if Input.GetMouseButtonDown(0) then
        yield true, false
        wait 2.0f
        yield false, true

  Create(pos : Vector3) = 
  {
    JeepPos = pos
    UnityZombie = UnityZombie.Instantiate(pos)
  }
}